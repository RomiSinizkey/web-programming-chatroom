<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>Chatroom</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
            rel="stylesheet"
    >
    <link
            rel="stylesheet"
            href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
    />

    <style>
        #messagesBox {
            height: 420px;
            overflow-y: auto;
            background: #fff;
        }
        .msg-meta {
            font-size: 0.8rem;
            color: #6c757d;
        }
        .msg-bubble {
            white-space: pre-wrap;
            word-break: break-word;
        }
    </style>
</head>

<body class="bg-light">
<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-12 col-md-10 col-lg-8">

            <div class="d-flex justify-content-between align-items-center mb-3">
                <h1 class="h4 mb-0">Chatroom</h1>
                <a href="/logout" class="btn btn-outline-secondary btn-sm">Logout</a>
            </div>

            <div class="alert alert-success" role="alert">
                Logged in as <strong><%= user.firstName %> <%= user.lastName %></strong>
                (<%= user.email %>)
            </div>

            <div class="card shadow-sm">
                <div class="card-body">

                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <div class="text-muted small">Messages (latest 50)</div>
                        <button id="refreshBtn" type="button" class="btn btn-sm btn-outline-primary">Refresh</button>
                    </div>

                    <div id="messagesBox" class="border rounded p-3 mb-3"></div>

                    <form id="sendForm" class="d-flex gap-2" autocomplete="off" method="POST" action="/messages">
                    <label for="msgInput" class="visually-hidden">Message</label>
                        <input
                                id="msgInput"
                                name="text"
                                type="text"
                                class="form-control"
                                maxlength="500"
                                placeholder="Type a message..."
                                required
                        />

                        <button id="sendBtn" class="btn btn-primary" type="submit">Send</button>
                    </form>

                    <div id="errorBox" class="mt-3 d-none alert alert-danger mb-0"></div>

                </div>
            </div>

        </div>
    </div>
</div>

<script>
    const currentUserEmail = "<%= user.email %>";

    const messagesBox = document.getElementById("messagesBox");
    const errorBox = document.getElementById("errorBox");
    const sendForm = document.getElementById("sendForm");
    const msgInput = document.getElementById("msgInput");
    const refreshBtn = document.getElementById("refreshBtn");
    const sendBtn = document.getElementById("sendBtn");

    let lastRenderedHash = "";

    function showError(msg) {
        if (!errorBox) return;
        errorBox.textContent = msg;
        errorBox.classList.remove("d-none");
    }

    function clearError() {
        if (!errorBox) return;
        errorBox.textContent = "";
        errorBox.classList.add("d-none");
    }

    function escapeHtml(str) {
        return String(str)
            .replaceAll("&", "&amp;")
            .replaceAll("<", "&lt;")
            .replaceAll(">", "&gt;")
            .replaceAll('"', "&quot;")
            .replaceAll("'", "&#039;");
    }

    function formatTime(iso) {
        if (!iso) return "";
        const d = new Date(iso);
        return Number.isNaN(d.getTime()) ? "" : d.toLocaleString();
    }

    function hashMessages(arr) {
        return JSON.stringify(arr.map(m => [m.id, m.updatedAt, m.deletedAt]));
    }

    function renderMessages(messages) {
        if (!messagesBox) return;

        const h = hashMessages(messages);
        if (h === lastRenderedHash) return;
        lastRenderedHash = h;

        messagesBox.innerHTML = "";

        if (!messages.length) {
            messagesBox.innerHTML = '<div class="text-muted">No messages yet.</div>';
            return;
        }

        for (const m of messages) {
            const email = (m.userEmail || "").toLowerCase();
            const isMine = email === String(currentUserEmail).toLowerCase();

            const wrapper = document.createElement("div");
            wrapper.className = "mb-3";

            const meta = document.createElement("div");
            meta.className = "msg-meta";
            const firstName = m.User?.firstName || "Unknown";
            meta.textContent = `${firstName} • ${formatTime(m.createdAt)}`;

            const bubble = document.createElement("div");
            bubble.className = "msg-bubble border rounded p-2 " + (isMine ? "bg-primary text-white" : "bg-light");

            // טקסט ההודעה
            const textDiv = document.createElement("div");
            textDiv.innerHTML = escapeHtml(m.text || "");
            bubble.appendChild(textDiv);

            wrapper.appendChild(meta);
            wrapper.appendChild(bubble);

            // פעולות רק על הודעות שלי
            if (isMine) {
                const actions = document.createElement("div");
                actions.className = "mt-2 d-flex gap-2 align-items-center";

                //  DELETE
                const deleteForm = document.createElement("form");
                deleteForm.method = "POST";
                deleteForm.action = "/messages/delete";

                const hiddenId1 = document.createElement("input");
                hiddenId1.type = "hidden";
                hiddenId1.name = "id";
                hiddenId1.value = String(m.id);

                const trashBtn = document.createElement("button");
                trashBtn.type = "submit";
                trashBtn.className = "btn btn-sm btn-outline-danger";
                trashBtn.title = "Delete";
                trashBtn.innerHTML = '<i class="fa-solid fa-trash"></i>';

                deleteForm.appendChild(hiddenId1);
                deleteForm.appendChild(trashBtn);

                // ️ EDIT (fetch)
                const editBtn = document.createElement("button");
                editBtn.type = "button";
                editBtn.className  = "btn btn-sm btn-outline-secondary";
                editBtn.title = "Edit";
                editBtn.innerHTML = '<i class="fa-solid fa-pen"></i>';

                editBtn.addEventListener("click", () => {

                    if (bubble.dataset.editing === "1") return;
                    bubble.dataset.editing = "1";

                    const originalText = m.text || "";

                    // מחליפים את הטקסט ב-input editable
                    const input = document.createElement("input");
                    input.type = "text";
                    input.maxLength = 500;
                    input.className = "form-control form-control-sm";
                    input.value = originalText;

                    // כפתורי שמירה/ביטול
                    const saveBtn = document.createElement("button");
                    saveBtn.type = "button";
                    saveBtn.className = "btn btn-sm btn-success";
                    saveBtn.innerHTML = '<i class="fa-solid fa-check"></i>';

                    const cancelBtn = document.createElement("button");
                    cancelBtn.type = "button";
                    cancelBtn.className = "btn btn-sm btn-outline-secondary";
                    cancelBtn.innerHTML = '<i class="fa-solid fa-xmark"></i>';

                    const editRow = document.createElement("div");
                    editRow.className = "d-flex gap-2 align-items-center";
                    editRow.appendChild(input);
                    editRow.appendChild(saveBtn);
                    editRow.appendChild(cancelBtn);

                    // מחליפים את התוכן של textDiv בעריכה
                    textDiv.innerHTML = "";
                    textDiv.appendChild(editRow);
                    input.focus();

                    async function save() {
                        const trimmed = input.value.trim();
                        if (!trimmed) return;

                        clearError();

                        const res = await fetch(`/api/messages/${m.id}`, {
                            method: "PATCH",
                            headers: { "Content-Type": "application/json", "Accept": "application/json" },
                            body: JSON.stringify({ text: trimmed }),
                        });

                        if (!res.ok) {
                            const body = await res.json().catch(() => ({}));
                            showError(body.error || `Failed to edit message (${res.status})`);
                            return;
                        }

                        bubble.dataset.editing = "0";
                        await loadMessages();
                    }

                    function cancel() {
                        // מחזירים לטקסט המקורי
                        bubble.dataset.editing = "0";
                        textDiv.innerHTML = escapeHtml(originalText);
                    }

                    saveBtn.addEventListener("click", () => void save());
                    cancelBtn.addEventListener("click", cancel);

                    input.addEventListener("keydown", (e) => {
                        if (e.key === "Enter") void save();
                        if (e.key === "Escape") cancel();
                    });
                });


                actions.appendChild(deleteForm);
                actions.appendChild(editBtn);
                wrapper.appendChild(actions);
            }

            messagesBox.appendChild(wrapper);
        }

        messagesBox.scrollTop = messagesBox.scrollHeight;
    }

    async function loadMessages() {
        clearError();

        const res = await fetch("/api/messages", { headers: { "Accept": "application/json" } });
        if (!res.ok) {
            const body = await res.json().catch(() => ({}));
            showError(body.error || `Failed to load messages (${res.status})`);
            return;
        }

        const messages = await res.json();
        renderMessages(messages);
    }



    // Events
    if (refreshBtn) refreshBtn.addEventListener("click", () => void loadMessages());



    // Init + polling
    const POLLING = 10_000; // 10 seconds

    void loadMessages();
    setInterval(() => void loadMessages(), POLLING);

</script>

</body>
</html>
