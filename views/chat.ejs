<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>Chatroom</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
            rel="stylesheet"
    >
    <style>
        #messagesBox {
            height: 420px;
            overflow-y: auto;
            background: #fff;
        }
        .msg-meta {
            font-size: 0.8rem;
            color: #6c757d;
        }
        .msg-bubble {
            white-space: pre-wrap;
            word-break: break-word;
        }
    </style>
</head>

<body class="bg-light">
<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-12 col-md-10 col-lg-8">

            <div class="d-flex justify-content-between align-items-center mb-3">
                <h1 class="h4 mb-0">Chatroom</h1>
                <a href="/logout" class="btn btn-outline-secondary btn-sm">Logout</a>
            </div>

            <div class="alert alert-success" role="alert">
                Logged in as <strong><%= user.firstName %> <%= user.lastName %></strong>
                (<%= user.email %>)
            </div>

            <div class="card shadow-sm">
                <div class="card-body">

                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <div class="text-muted small">Messages (latest 50)</div>
                        <button id="refreshBtn" type="button" class="btn btn-sm btn-outline-primary">Refresh</button>
                    </div>

                    <div id="messagesBox" class="border rounded p-3 mb-3"></div>

                    <form id="sendForm" class="d-flex gap-2" autocomplete="off">
                        <label for="msgInput" class="visually-hidden">Message</label>
                        <input
                                id="msgInput"
                                type="text"
                                class="form-control"
                                maxlength="500"
                                placeholder="Type a message..."
                                required
                        />
                        <button id="sendBtn" class="btn btn-primary" type="submit">Send</button>
                    </form>

                    <div id="errorBox" class="mt-3 d-none alert alert-danger mb-0"></div>

                </div>
            </div>

        </div>
    </div>
</div>

<script>
    const currentUserEmail = "<%= user.email %>";

    const messagesBox = document.getElementById("messagesBox");
    const errorBox = document.getElementById("errorBox");
    const sendForm = document.getElementById("sendForm");
    const msgInput = document.getElementById("msgInput");
    const refreshBtn = document.getElementById("refreshBtn");
    const sendBtn = document.getElementById("sendBtn");

    let lastRenderedHash = "";

    function showError(msg) {
        if (!errorBox) return;
        errorBox.textContent = msg;
        errorBox.classList.remove("d-none");
    }

    function clearError() {
        if (!errorBox) return;
        errorBox.textContent = "";
        errorBox.classList.add("d-none");
    }

    function escapeHtml(str) {
        return String(str)
            .replaceAll("&", "&amp;")
            .replaceAll("<", "&lt;")
            .replaceAll(">", "&gt;")
            .replaceAll('"', "&quot;")
            .replaceAll("'", "&#039;");
    }

    function formatTime(iso) {
        if (!iso) return "";
        const d = new Date(iso);
        return Number.isNaN(d.getTime()) ? "" : d.toLocaleString();
    }

    function hashMessages(arr) {
        return JSON.stringify(arr.map(m => [m.id, m.updatedAt, m.deletedAt]));
    }

    function renderMessages(messages) {
        if (!messagesBox) return;

        const h = hashMessages(messages);
        if (h === lastRenderedHash) return;
        lastRenderedHash = h;

        messagesBox.innerHTML = "";

        if (!messages.length) {
            messagesBox.innerHTML = '<div class="text-muted">No messages yet.</div>';
            return;
        }

        for (const m of messages) {
            const email = (m.userEmail || "").toLowerCase();
            const isMine = email === String(currentUserEmail).toLowerCase();

            const wrapper = document.createElement("div");
            wrapper.className = "mb-3";

            const meta = document.createElement("div");
            meta.className = "msg-meta";
            meta.textContent = `${m.userEmail || "Unknown"} â€¢ ${formatTime(m.createdAt)}`;

            const bubble = document.createElement("div");
            bubble.className = "msg-bubble border rounded p-2 " + (isMine ? "bg-primary text-white" : "bg-light");
            bubble.innerHTML = escapeHtml(m.text || "");

            wrapper.appendChild(meta);
            wrapper.appendChild(bubble);
            messagesBox.appendChild(wrapper);
        }

        messagesBox.scrollTop = messagesBox.scrollHeight;
    }

    async function loadMessages() {
        clearError();

        const res = await fetch("/api/messages", { headers: { "Accept": "application/json" } });
        if (!res.ok) {
            const body = await res.json().catch(() => ({}));
            showError(body.error || `Failed to load messages (${res.status})`);
            return;
        }

        const messages = await res.json();
        renderMessages(messages);
    }

    async function sendMessage(text) {
        clearError();
        if (sendBtn) sendBtn.disabled = true;

        const res = await fetch("/api/messages", {
            method: "POST",
            headers: { "Content-Type": "application/json", "Accept": "application/json" },
            body: JSON.stringify({ text })
        });

        if (!res.ok) {
            const body = await res.json().catch(() => ({}));
            showError(body.error || `Failed to send message (${res.status})`);
            if (sendBtn) sendBtn.disabled = false;
            return;
        }

        if (msgInput) msgInput.value = "";
        if (sendBtn) sendBtn.disabled = false;
        if (msgInput) msgInput.focus();

        await loadMessages();
    }

    // Events
    if (refreshBtn) refreshBtn.addEventListener("click", () => void loadMessages());

    if (sendForm) {
        sendForm.addEventListener("submit", (e) => {
            e.preventDefault();
            const text = (msgInput && msgInput.value ? msgInput.value : "").trim();
            if (!text) return;
            void sendMessage(text);
        });
    }

    // Init + polling
    void loadMessages();
    setInterval(() => void loadMessages(), 2000);
</script>

</body>
</html>
