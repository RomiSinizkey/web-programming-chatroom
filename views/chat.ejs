<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>Chatroom</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
            rel="stylesheet"
    >
    <link
            rel="stylesheet"
            href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
    >

    <link rel="stylesheet" href="/stylesheets/style.css">
</head>

<body class="bg-light">

<%
// noinspection JSUnresolvedReference,JSUnresolvedVariable,JSCheckFunctionSignatures
const user = (locals && locals.user) ? locals.user : { email:"", firstName:"", lastName:"" };
%>

<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-12 col-md-10 col-lg-8">

            <div class="d-flex justify-content-between align-items-center mb-3">
                <h1 class="h4 mb-0">Chatroom</h1>
                <a href="/logout" class="btn btn-outline-secondary btn-sm">Logout</a>
            </div>

            <div class="alert alert-success" role="alert">
                Logged in as <strong><%= user.firstName %> <%= user.lastName %></strong>
                (<%= user.email %>)
            </div>

            <div class="card shadow-sm">
                <div class="card-body">

                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <div class="text-muted small">Messages (latest 50)</div>

                        <div class="d-flex gap-2">
                            <button id="selectAllBtn" type="button" class="btn btn-sm btn-outline-secondary">Select all</button>
                            <button id="clearAllBtn" type="button" class="btn btn-sm btn-outline-secondary">Clear</button>
                            <button id="deleteSelectedBtn" type="button" class="btn btn-sm btn-outline-danger" disabled>
                                Delete selected
                            </button>
                            <button id="refreshBtn" type="button" class="btn btn-sm btn-outline-primary">Refresh</button>
                        </div>
                    </div>

                    <div class="d-flex gap-2 align-items-center mb-2">
                        <label for="searchInput" class="visually-hidden">Search messages</label>
                        <input
                                id="searchInput" class="form-control form-control-sm"
                                type="text" placeholder="Search messages in DB..."
                                autocomplete="off"
                        />

                        <button id="prevMatchBtn" type="button" class="btn btn-sm btn-outline-secondary" disabled>Prev</button>
                        <button id="nextMatchBtn" type="button" class="btn btn-sm btn-outline-secondary" disabled>Next</button>

                        <div id="matchInfo" class="text-muted small ms-1"></div>
                    </div>

                    <div id="messagesBox" class="border rounded p-3 mb-3"></div>

                    <form id="sendForm" class="d-flex gap-2" autocomplete="off" method="POST" action="/messages">
                        <label for="msgInput" class="visually-hidden">Message</label>
                        <input
                                id="msgInput"
                                name="text"
                                type="text"
                                class="form-control"
                                maxlength="500"
                                placeholder="Type a message..."
                                required
                        />
                        <button id="sendBtn" class="btn btn-primary" type="submit">Send</button>
                    </form>

                    <div id="errorBox" class="mt-3 d-none alert alert-danger mb-0"></div>

                </div>
            </div>

        </div>
    </div>
</div>

<script>
    /**
     * Browser JS (NOT Node).
     * @typedef {{ id:number, text:string, userEmail:string, createdAt:string, updatedAt:string, deletedAt:(string|null), User?:{firstName?:string} }} ChatMessage
     */

    /* global window, document, fetch, confirm, setTimeout, clearTimeout */

    const currentUserEmail = "<%= String(user.email || '') %>";

    const messagesBox = document.getElementById("messagesBox");
    const errorBox = document.getElementById("errorBox");
    const refreshBtn = document.getElementById("refreshBtn");
    const selectAllBtn = document.getElementById("selectAllBtn");
    const clearAllBtn = document.getElementById("clearAllBtn");
    const deleteSelectedBtn = document.getElementById("deleteSelectedBtn");

    const searchInput = document.getElementById("searchInput");
    const prevMatchBtn = document.getElementById("prevMatchBtn");
    const nextMatchBtn = document.getElementById("nextMatchBtn");
    const matchInfo = document.getElementById("matchInfo");

    // ✅ missing in your code:
    const sendForm = document.getElementById("sendForm");
    const msgInput = document.getElementById("msgInput");

    /** @type {ChatMessage[]} */
    let allMessages = [];
    /** @type {ChatMessage[]} */
    let filteredMessages = [];

    /** @type {string[]} */
    let matchIds = [];
    let currentMatchIndex = -1;

    /** @type {Set<string>} */
    const selectedIds = new Set();

    let lastRenderedHash = "";

    function safeCssEscape(s) {
        if (window.CSS && typeof window.CSS.escape === "function") return window.CSS.escape(String(s));
        return String(s).replace(/[^a-zA-Z0-9_-]/g, "\\$&");
    }

    function redirectToLogin(reason) {
        const msg = reason || "Session expired, please login again";
        window.location.href = "/?msg=" + encodeURIComponent(msg);
    }

    function showError(msg) {
        if (!errorBox) return;
        errorBox.textContent = msg;
        errorBox.classList.remove("d-none");
    }

    function clearError() {
        if (!errorBox) return;
        errorBox.textContent = "";
        errorBox.classList.add("d-none");
    }

    function updateDeleteSelectedUI() {
        if (!deleteSelectedBtn) return;
        deleteSelectedBtn.disabled = selectedIds.size === 0;
        deleteSelectedBtn.textContent = selectedIds.size === 0
            ? "Delete selected"
            : `Delete selected (${selectedIds.size})`;
    }

    function escapeHtml(str) {
        return String(str)
            .replaceAll("&", "&amp;")
            .replaceAll("<", "&lt;")
            .replaceAll(">", "&gt;")
            .replaceAll('"', "&quot;")
            .replaceAll("'", "&#039;");
    }

    function escapeRegex(s) {
        return s.replace(/[.*+?^${}()|[\]\\]/g, "\\$&");
    }

    function highlightText(text, query) {
        const safe = escapeHtml(text || "");
        const q = (query || "").trim();
        if (!q) return safe;
        const re = new RegExp(escapeRegex(q), "gi");
        return safe.replace(re, (m) => `<mark class="chat-highlight">${m}</mark>`);
    }

    function formatTime(iso) {
        if (!iso) return "";
        const d = new Date(iso);
        return Number.isNaN(d.getTime()) ? "" : d.toLocaleString();
    }

    function hashMessages(arr, q) {
        return JSON.stringify({
            q: q || "",
            rows: arr.map(m => [m.id, m.updatedAt, m.deletedAt])
        });
    }

    function applySearchAndRender() {
        const q = (searchInput && searchInput.value ? searchInput.value : "").trim();
        filteredMessages = allMessages;

        if (q) {
            const qLower = q.toLowerCase();
            matchIds = filteredMessages
                .filter(m => String(m.text || "").toLowerCase().includes(qLower))
                .map(m => String(m.id));
        } else {
            matchIds = [];
        }

        currentMatchIndex = matchIds.length ? 0 : -1;

        if (prevMatchBtn) prevMatchBtn.disabled = matchIds.length === 0;
        if (nextMatchBtn) nextMatchBtn.disabled = matchIds.length === 0;

        if (matchInfo) {
            matchInfo.textContent = matchIds.length
                ? `1 / ${matchIds.length}`
                : (q ? "0 matches" : "");
        }

        renderMessages(filteredMessages, q);
        highlightCurrentMatchInDom();
    }

    // ✅ scroll ONLY inside the chat box (never the whole page)
    function highlightCurrentMatchInDom() {
        if (!messagesBox) return;
        if (currentMatchIndex < 0 || !matchIds.length) return;

        messagesBox.querySelectorAll("mark.chat-highlight.current")
            .forEach(el => el.classList.remove("current"));

        const targetId = matchIds[currentMatchIndex];
        const wrapper = messagesBox.querySelector(`[data-msg-id="${safeCssEscape(targetId)}"]`);
        if (!wrapper) return;

        const firstMark = wrapper.querySelector("mark.chat-highlight");
        if (firstMark) firstMark.classList.add("current");

        // scroll inside messagesBox only
        const top = wrapper.offsetTop;
        const bottom = top + wrapper.offsetHeight;

        const viewTop = messagesBox.scrollTop;
        const viewBottom = viewTop + messagesBox.clientHeight;

        if (top < viewTop) {
            messagesBox.scrollTo({ top, behavior: "smooth" });
        } else if (bottom > viewBottom) {
            messagesBox.scrollTo({ top: bottom - messagesBox.clientHeight, behavior: "smooth" });
        }
    }

    function renderMessages(messages, q) {
        if (!messagesBox) return;

        const h = hashMessages(messages, q);
        if (h === lastRenderedHash) return;
        lastRenderedHash = h;

        messagesBox.innerHTML = "";

        if (!messages.length) {
            messagesBox.innerHTML = '<div class="text-muted">No messages yet.</div>';
            return;
        }

        for (const m of messages) {
            const email = String(m.userEmail || "").toLowerCase();
            const isMine = email === String(currentUserEmail || "").toLowerCase();

            const wrapper = document.createElement("div");
            wrapper.className = "mb-3";
            wrapper.setAttribute("data-msg-id", String(m.id));

            const meta = document.createElement("div");
            meta.className = "msg-meta";
            const firstName = (m.User && m.User.firstName) ? m.User.firstName : "Unknown";
            meta.textContent = `${firstName} • ${formatTime(m.createdAt)}`;

            const bubble = document.createElement("div");
            bubble.className = "msg-bubble border rounded p-2 " + (isMine ? "bg-primary text-white" : "bg-light");

            const textDiv = document.createElement("div");
            textDiv.innerHTML = highlightText(m.text || "", q);
            bubble.appendChild(textDiv);

            wrapper.appendChild(meta);
            wrapper.appendChild(bubble);

            if (isMine) {
                const actions = document.createElement("div");
                actions.className = "mt-2 d-flex gap-2 align-items-center";

                const cb = document.createElement("input");
                cb.type = "checkbox";
                cb.className = "form-check-input mt-0";
                cb.title = "Select";

                const idStr = String(m.id);
                cb.value = idStr;
                cb.checked = selectedIds.has(idStr);

                cb.addEventListener("change", () => {
                    if (cb.checked) selectedIds.add(idStr);
                    else selectedIds.delete(idStr);
                    updateDeleteSelectedUI();
                });

                actions.appendChild(cb);

                const deleteForm = document.createElement("form");
                deleteForm.method = "POST";
                deleteForm.action = "/messages/delete";

                const hiddenId = document.createElement("input");
                hiddenId.type = "hidden";
                hiddenId.name = "id";
                hiddenId.value = idStr;

                const trashBtn = document.createElement("button");
                trashBtn.type = "submit";
                trashBtn.className = "btn btn-sm btn-outline-danger";
                trashBtn.title = "Delete";
                trashBtn.innerHTML = '<i class="fa-solid fa-trash"></i>';

                deleteForm.appendChild(hiddenId);
                deleteForm.appendChild(trashBtn);

                deleteForm.addEventListener("submit", (e) => {
                    const preview = String(m.text || "").trim();
                    const ok = confirm(`Are you sure? Deleting a message cannot be undone.\n\nMessage:\n"${preview}"`);
                    if (!ok) e.preventDefault();
                });

                const editBtn = document.createElement("button");
                editBtn.type = "button";
                editBtn.className = "btn btn-sm btn-outline-secondary";
                editBtn.title = "Edit";
                editBtn.innerHTML = '<i class="fa-solid fa-pen"></i>';

                editBtn.addEventListener("click", () => {
                    if (bubble.getAttribute("data-editing") === "1") return;
                    bubble.setAttribute("data-editing", "1");

                    const originalText = String(m.text || "");

                    const input = document.createElement("input");
                    input.type = "text";
                    input.maxLength = 500;
                    input.className = "form-control form-control-sm";
                    input.value = originalText;

                    const saveBtn = document.createElement("button");
                    saveBtn.type = "button";
                    saveBtn.className = "btn btn-sm btn-success";
                    saveBtn.innerHTML = '<i class="fa-solid fa-check"></i>';

                    const cancelBtn = document.createElement("button");
                    cancelBtn.type = "button";
                    cancelBtn.className = "btn btn-sm btn-outline-secondary";
                    cancelBtn.innerHTML = '<i class="fa-solid fa-xmark"></i>';

                    const editRow = document.createElement("div");
                    editRow.className = "d-flex gap-2 align-items-center";
                    editRow.appendChild(input);
                    editRow.appendChild(saveBtn);
                    editRow.appendChild(cancelBtn);

                    textDiv.innerHTML = "";
                    textDiv.appendChild(editRow);
                    input.focus();

                    async function save() {
                        const trimmed = input.value.trim();
                        if (!trimmed) return;

                        clearError();

                        const res = await fetch(`/api/messages/${m.id}`, {
                            method: "PATCH",
                            headers: { "Content-Type": "application/json", "Accept": "application/json" },
                            credentials: "same-origin",
                            body: JSON.stringify({ text: trimmed }),
                        });

                        if (res.status === 401) return redirectToLogin();

                        if (!res.ok) {
                            const body = await res.json().catch(() => ({}));
                            showError(body.error || `Failed to edit message (${res.status})`);
                            return;
                        }

                        bubble.setAttribute("data-editing", "0");
                        await loadMessages();
                    }

                    function cancel() {
                        bubble.setAttribute("data-editing", "0");
                        textDiv.innerHTML = highlightText(originalText, q);
                        highlightCurrentMatchInDom();
                    }

                    saveBtn.addEventListener("click", () => void save());
                    cancelBtn.addEventListener("click", cancel);

                    input.addEventListener("keydown", (e) => {
                        if (e.key === "Enter") void save();
                        if (e.key === "Escape") cancel();
                    });
                });

                actions.appendChild(editBtn);
                actions.appendChild(deleteForm);
                wrapper.appendChild(actions);
            }

            messagesBox.appendChild(wrapper);
        }

        // ✅ real chat behavior:
        // only auto-scroll when NOT searching
        if (!q) {
            messagesBox.scrollTop = messagesBox.scrollHeight;
        }
    }

    async function fetchMessagesFromServer(q) {
        const url = q
            ? `/api/messages/search?q=${encodeURIComponent(q)}`
            : `/api/messages`;

        const res = await fetch(url, {
            method: "GET",
            headers: { "Accept": "application/json", "Cache-Control": "no-cache" },
            cache: "no-store",
            credentials: "same-origin",
        });

        if (res.status === 401) {
            redirectToLogin();
            return null;
        }

        if (!res.ok) {
            const body = await res.json().catch(() => ({}));
            showError(body.error || `Failed to load messages (${res.status})`);
            return null;
        }

        return await res.json();
    }

    async function loadMessages() {
        clearError();
        const q = (searchInput && searchInput.value ? searchInput.value : "").trim();
        const messages = await fetchMessagesFromServer(q);
        if (!messages) return;

        allMessages = messages;
        applySearchAndRender();
    }

    if (refreshBtn) refreshBtn.addEventListener("click", () => void loadMessages());

    if (selectAllBtn) {
        selectAllBtn.addEventListener("click", () => {
            selectedIds.clear();
            for (const m of filteredMessages) {
                if (String(m.userEmail || "").toLowerCase() === String(currentUserEmail || "").toLowerCase()) {
                    selectedIds.add(String(m.id));
                }
            }
            document.querySelectorAll('input[type="checkbox"]').forEach(cb => {
                cb.checked = selectedIds.has(cb.value);
            });
            updateDeleteSelectedUI();
        });
    }

    if (clearAllBtn) {
        clearAllBtn.addEventListener("click", () => {
            selectedIds.clear();
            document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
            updateDeleteSelectedUI();
        });
    }

    if (deleteSelectedBtn) {
        deleteSelectedBtn.addEventListener("click", async () => {
            if (selectedIds.size === 0) return;
            if (!confirm(`Delete ${selectedIds.size} selected messages?`)) return;

            clearError();

            const ids = Array.from(selectedIds);

            const res = await fetch("/api/messages/delete-many", {
                method: "POST",
                headers: { "Content-Type": "application/json", "Accept": "application/json" },
                credentials: "same-origin",
                body: JSON.stringify({ ids }),
            });

            if (res.status === 401) return redirectToLogin();

            if (!res.ok) {
                const body = await res.json().catch(() => ({}));
                showError(body.error || `Failed to delete messages (${res.status})`);
                return;
            }

            selectedIds.clear();
            updateDeleteSelectedUI();
            await loadMessages();
        });
    }

    let searchTimer = null;
    if (searchInput) {
        searchInput.addEventListener("input", () => {
            clearTimeout(searchTimer);
            searchTimer = setTimeout(() => void loadMessages(), 250);
        });
    }

    // ✅ BONUS: send without page reload (no jump to top)
    if (sendForm && msgInput) {
        sendForm.addEventListener("submit", async (e) => {
            e.preventDefault();

            const text = msgInput.value.trim();
            if (!text) return;

            clearError();

            const res = await fetch("/api/messages", {
                method: "POST",
                headers: { "Content-Type": "application/json", "Accept": "application/json" },
                credentials: "same-origin",
                body: JSON.stringify({ text }),
            });

            if (res.status === 401) return redirectToLogin();

            if (!res.ok) {
                const body = await res.json().catch(() => ({}));
                showError(body.error || `Failed to send message (${res.status})`);
                return;
            }

            msgInput.value = "";
            await loadMessages();

            // keep input ready
            msgInput.focus();
        });
    }

    if (nextMatchBtn) {
        nextMatchBtn.addEventListener("click", () => {
            nextMatchBtn.blur(); // bonus
            if (!matchIds.length) return;
            currentMatchIndex = (currentMatchIndex + 1) % matchIds.length;
            if (matchInfo) matchInfo.textContent = `${currentMatchIndex + 1} / ${matchIds.length}`;
            highlightCurrentMatchInDom();
        });
    }

    if (prevMatchBtn) {
        prevMatchBtn.addEventListener("click", () => {
            prevMatchBtn.blur(); // bonus
            if (!matchIds.length) return;
            currentMatchIndex = (currentMatchIndex - 1 + matchIds.length) % matchIds.length;
            if (matchInfo) matchInfo.textContent = `${currentMatchIndex + 1} / ${matchIds.length}`;
            highlightCurrentMatchInDom();
        });
    }

    updateDeleteSelectedUI();
    void loadMessages();
</script>

</body>
</html>
